#!/usr/bin/env bash

set -o nounset -o pipefail -o errexit

clean() {
  if [[ -n ${GOPATH:-} ]]; then
    sudo rm -rf "${GOPATH}"
    mkdir -p "${GOPATH}"
  fi

  rm -rf "${HOME}/opt/go"
  rm -rf "${HOME}/.dlv"
}

install() {
  local GO_VERSION="1.16.2"

  local ARCH
  ARCH="$(normalized_arch "amd64" "armv6l" "arm64")"

  if [[ ! -d "${HOME}/opt/go" ]]; then
    local GO_ARCHIVE
    GO_ARCHIVE="go${GO_VERSION}.$(normalized_os)-${ARCH}.tar.gz"

    curl --disable --silent --show-error --location --max-time 300 --remote-name "https://dl.google.com/go/${GO_ARCHIVE}"
    tar -C "${HOME}/opt" -xzf "${GO_ARCHIVE}"
    rm -rf "${GO_ARCHIVE}"
  fi

  local SCRIPT_DIR
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  source "${SCRIPT_DIR}/../sources/golang"
  mkdir -p "${GOPATH}"

  packages_install graphviz

  if command -v go >/dev/null 2>&1; then
    if [[ ${ARCH} == "amd64" ]]; then
      go get -u github.com/go-delve/delve/cmd/dlv
    fi

    go get -u github.com/kisielk/errcheck
    go get -u golang.org/x/lint/golint
    go get -u golang.org/x/tools/cmd/goimports
    go get -u golang.org/x/tools/go/analysis/passes/fieldalignment/cmd/fieldalignment
  fi
}
