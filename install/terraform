#!/usr/bin/env bash

set -o nounset -o pipefail -o errexit

clean() {
  rm -rf "${HOME}/.terraform"*
}

install() {
  local TERRAFORM_LS_VERSION="0.28.1"

  terraform_install "1.2.5"

  mkdir -p "${HOME}/.terraform.d/plugin-cache"
  printf "plugin_cache_dir = \"%s/.terraform.d/plugin-cache\"\ndisable_checkpoint = true\n" "${HOME}" >"${HOME}/.terraformrc"

  archive_to_binary "https://github.com/hashicorp/terraform-ls/releases/download/v${TERRAFORM_LS_VERSION}/terraform-ls_${TERRAFORM_LS_VERSION}_$(normalized_os)_$(normalized_arch "amd64" "arm" "arm64").zip" "terraform-ls"
}

credentials() {
  if ! command -v pass >/dev/null 2>&1; then
    exit
  fi

  if [[ $(pass find terraform | wc -l) -gt 1 ]]; then
    printf "credentials \"app.terraform.io\" {\n  token = \"%s\"\n}" "$(pass show "dev/terraform" | awk -F': ' '$1 == "token" {printf("%s", $2)}')" >>"${HOME}/.terraformrc"
    chmod 600 "${HOME}/.terraformrc"
  fi
}
