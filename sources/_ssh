#!/usr/bin/env bash

SSH_ENV="${HOME}/.ssh/environment"

stop_ssh_agent() {
  if [[ -n ${SSH_AGENT_PID:-} ]]; then
    ssh-agent -k
    rm -rf "${SSH_ENV}"
  fi
}

add_ssh_key() {
  ssh-add -t 1h -k "${1:-${HOME}/.ssh/id_ed25519}"
}

init_ssh_agent() {
  printf "Initializing new SSH agent...\n"

  touch "${SSH_ENV}"
  chmod 600 "${SSH_ENV}"

  ssh-agent | sed 's/^echo/#echo/' > "${SSH_ENV}"
  source "${SSH_ENV}" > /dev/null
}

start_ssh_agent() {
  stop_ssh_agent

  local SSH_NAMES=('ed25519' 'ecdsa' 'rsa')
  local INITIALIZED="false"

  for type in "${SSH_NAMES[@]}"; do
    local KEY_NAME="${HOME}/.ssh/id_${type}"

    if [[ -e ${KEY_NAME} ]]; then
      if [[ ${INITIALIZED} != "true" ]]; then
        init_ssh_agent
        INITIALIZED="true"
      fi

      add_ssh_key "${KEY_NAME}"
    fi
  done
}

if [[ -f ${SSH_ENV} ]]; then
  source "${SSH_ENV}" > /dev/null

  if [[ -n ${SSH_AGENT_PID:-} ]]; then
    kill -0 "${SSH_AGENT_PID}" 2>/dev/null || {
      start_ssh_agent
    }
  fi
else
    start_ssh_agent
fi
