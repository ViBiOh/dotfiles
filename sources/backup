#!/usr/bin/env bash

backup() {
  tar -czf - . | pv | gpg --symmetric --cipher-algo AES256 --batch --passphrase "${1:-$(pass show "infra/backup" | awk -F': ' '$1 == "aes" {printf("%s", $2)}')}" >"$(basename "$(pwd)").tar.gz.gpg"
}

upload() {
  MC_UPLOAD_MULTIPART_SIZE=104857600 mc mv "${1:-$(basename "$(pwd)")}.tar.gz.gpg" "scw/fibr/"
}

backup_dir() {
  (
    cd "${1:-}" || return
    backup ""
    upload ""
  )
}

backup_all() {
  tmux_batch -a backup_dir 'find . -mindepth 1 -maxdepth 1 -type d -not -path "./.*" -print0'
}

restore() {
  local BASE_FILENAME="${1:-backup}"

  mkdir "${BASE_FILENAME}"
  gpg --decrypt --batch --passphrase "${2:-$(pass show "infra/backup" | awk -F': ' '$1 == "aes" {printf("%s", $2)}')}" "${BASE_FILENAME}.tar.gz.gpg" | pv | tar -xz -C "${BASE_FILENAME}" -
}
