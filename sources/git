#!/usr/bin/env bash

if ! command -v git >/dev/null 2>&1; then
  return
fi

if command -v delta >/dev/null 2>&1; then
  export GIT_PAGER='delta --dark'
fi

...() {
  cd "$(git_root)" || return 1
}

jira_pull_request() {
  git push

  local GIT_CURRENT_BRANCH
  GIT_CURRENT_BRANCH="$(git current-branch)"

  local JIRA_TICKET_ID
  JIRA_TICKET_ID="$(jira print "${GIT_CURRENT_BRANCH}")"

  local PULL_REQUEST_BODY
  if [[ -e ".github/PULL_REQUEST_TEMPLATE.md" ]]; then
    PULL_REQUEST_BODY="$(cat ".github/PULL_REQUEST_TEMPLATE.md")"
  else
    PULL_REQUEST_BODY="[${JIRA_TICKET_ID}]($(jira url "${JIRA_TICKET_ID}"))"
  fi

  github_pull_request "$(git remote-repository)" "$(jira summary "${JIRA_TICKET_ID}")" "$(git default-branch)" "${GIT_CURRENT_BRANCH}" "${PULL_REQUEST_BODY}"
  jira transition "${JIRA_TICKET_ID}" "in review"
}
