#!/usr/bin/env bash

if ! command -v git >/dev/null 2>&1; then
  return
fi

if command -v delta >/dev/null 2>&1; then
  export GIT_PAGER='delta --dark'
fi

...() {
  cd "$(git_root)" || return 1
}

jira() {
  if [[ -z ${JIRA_URL:-} ]]; then
    return
  fi

  local JIRA_TICKET
  JIRA_TICKET="$(curl \
    --disable \
    --silent \
    --show-error \
    --location \
    --max-time 30 \
    --user "$(passget "${JIRA_CREDENTIALS}" "login"):$(pass "${JIRA_CREDENTIALS}" | head -1)" \
    "${JIRA_URL}/rest/api/2/search?jql=status%20NOT%20IN%20%28Done%2C%20Resolved%29%20AND%20assignee%20%3D%20currentUser%28%29" |
    jq -r '.issues[] | .key + " " + .fields.summary' |
    fzf --height=20 --ansi --reverse --query="${1:-}" |
    awk '{print $1}')"

  if [[ -z ${JIRA_TICKET:-} ]]; then
    return
  fi

  if git rev-parse --is-inside-work-tree != "true" 2>&1; then
    printf "%s" "${JIRA_TICKET}"
  fi

  local JIRA_BRANCH_NAME=""feat-${JIRA_TICKET}""

  local CHECKOUT_OPTION=""
  if git rev-parse --quiet --verify "${JIRA_BRANCH_NAME}" >/dev/null 2>&1; then
    CHECKOUT_OPTION+=" -b"
  fi

  git checkout "${CHECKOUT_OPTION}" "${JIRA_BRANCH_NAME}"
}
