#!/usr/bin/env bash

open_ports() {
  if [[ ${OSTYPE} =~ ^darwin ]]; then
    sudo lsof -PniTCP -sTCP:LISTEN
  elif command -v ss >/dev/null 2>&1; then
    sudo ss -plant
  elif command -v netstat >/dev/null 2>&1; then
    sudo netstat -pluton
  fi
}

dns_flush_cache() {
  if command -v unbound-control >/dev/null 2>&1; then
    local UNBOUND_CONF_FOLDER="${BREW_PREFIX:-}/etc/unbound"
    local UNBOUND_DNSSEC_CERT="${UNBOUND_CONF_FOLDER}/root.key"
    local UNBOUND_CONF_FILE="${UNBOUND_CONF_FOLDER}/unbound.conf"

    sudo unbound-anchor -a "${UNBOUND_DNSSEC_CERT}"
    sudo unbound-control -c "${UNBOUND_CONF_FILE}" -q reload 2>/dev/null || true
    sudo unbound-control -c "${UNBOUND_CONF_FILE}" -q stop 2>/dev/null || true

    printf "Waiting 1 second before starting again...\n"
    sleep 1

    sudo unbound-control -c "${UNBOUND_CONF_FILE}" -q start
  fi

  if [[ ${OSTYPE} =~ ^darwin ]]; then
    sudo dscacheutil -flushcache
    sudo killall -HUP mDNSResponder
  else
    if [[ $(systemctl list-units systemd-resolve* | wc -l) -gt 2 ]]; then
      sudo systemd-resolve --flush-caches
    fi
  fi
}
