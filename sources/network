#!/usr/bin/env bash

open_ports() {
  if [[ ${OSTYPE} =~ ^darwin ]]; then
    sudo lsof -PniTCP -sTCP:LISTEN
  elif command -v ss >/dev/null 2<&1; then
    sudo ss -plant
  elif command -v netstat >/dev/null 2<&1; then
    sudo netstat -pluton
  fi
}

forward_local_port() {
  if [[ ${#} -ne 3 ]]; then
    printf "Usage: forward_local_port [LOCAL_PORT] [REMOTE_PORT] [SSH_PART]\n"
    return 1
  fi

  ssh -L "${1}:localhost:${2}" "${3}"
}

forward_remote_port() {
  if [[ ${#} -ne 3 ]]; then
    printf "Usage: forward_remote_port [REMOTE_PORT] [LOCAL_PORT] [SSH_PART]\n"
    return 1
  fi

  ssh -R "${1}:localhost:${2}" "${3}"
}

dns_flush_cache() {
  if [[ ${OSTYPE} =~ ^darwin ]]; then
    sudo dscacheutil -flushcache
    sudo killall -HUP mDNSResponder

    if [[ $(brew services list | grep -c dnsmasq) -eq 1 ]]; then
      sudo brew services restart dnsmasq
    fi
  else
    if [[ $(systemctl list-units systemd-resolve* | wc -l) -gt 2 ]]; then
      sudo systemd-resolve --flush-caches
    fi

    if [[ $(systemctl list-units dnsmasq* | wc -l) -gt 2 ]]; then
      sudo systemctl restart dnsmasq
    fi
  fi
}
