#!/usr/bin/env bash

export GIT_PS1_SHOWDIRTYSTATE="true"
export GIT_PS1_STATESEPARATOR="|"
export GIT_PS1_SHOWSTASHSTATE="true"
export GIT_PS1_SHOWUNTRACKEDFILES="true"
export GIT_PS1_COMPRESSSPARSESTATE="true"

export PROMPT_DIRTRIM="3"

_previous_status() {
  if [[ ${?} -eq 0 ]]; then
    printf -- "%b✔%b" "${GREEN}" "${RESET}"
  else
    printf -- "%bx%b" "${RED}" "${RESET}"
  fi
}

PS1="${BLUE}\u${RESET}@${RED}\h${RESET} ${GREEN}\w${RESET}"
if [[ "$(type -t __git_ps1)" == "function" ]]; then
  PS1+="${YELLOW}\$(__git_ps1)${RESET}"
fi

if [[ "$(type -t __kube_ps1)" == "function" ]]; then
  PS1+="${BLUE}\$(__kube_ps1)${RESET}"
fi

PS1+=' $(_previous_status)'

ps1_start_date() {
  export PS1_START_SECOND
  PS1_START_SECOND="$(printf '%(%s)T')"
}

ps1_duration() {
  local PS1_END_SECOND
  PS1_END_SECOND="$(printf '%(%s)T')"

  local PS1_DURATION_SECOND
  PS1_DURATION_SECOND="$((PS1_END_SECOND - PS1_START_SECOND))"

  if [[ ${PS1_DURATION_SECOND} -eq 0 ]]; then
    return
  fi

  printf " ⏳%ds" "${PS1_DURATION_SECOND}"
}

trap "ps1_start_date" DEBUG
PS1+='$(ps1_duration)'

PS1+="\n> "
export PS1
