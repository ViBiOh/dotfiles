" Turnoff vi backward compatibility
set nocompatible

" Enable syntax color if exist
if exists(":syntax")
  syntax on
endif

" Set color width
set t_Co=256

" setting colorscheme to ensure it
colorscheme default

" Show status line
set laststatus=2

highlight StatusLine ctermfg=235 ctermbg=11
highlight User1 ctermfg=11 ctermbg=238
highlight User2 ctermfg=232 ctermbg=154
highlight User3 ctermfg=2 ctermbg=235
highlight clear SignColumn

set statusline=
set statusline+=%1*\ \%f " Filename
set statusline+=%2*\%m" Modified
set statusline+=%*\%R " Read-Only indicator
set statusline+=%=
set statusline+=%3*\%y " Type of file
set statusline+=\ %{&fileencoding?&fileencoding:&encoding}
set statusline+=\[%{&fileformat}\]
set statusline+=%1*\ %p%% " Percentage of the file
set statusline+=\ %l:%c " Line Number and Total Line
set statusline+=\  " Empty space at end

" Line highlight
set cursorline

" Show line numbers
set number

" Default file encoding
set encoding=utf-8

" Show current command combination on bottom right
set showcmd

" Confirm change save
set confirm

" Wrap lines
set wrap

" Spaces tab's width and indent size
set tabstop=2 shiftwidth=2
if exists(':filetype')
  filetype indent on
  filetype plugin on
endif

" Show matching parenthesis
set showmatch

" Insert spaces instead of tabs
set expandtab

" Backspace behavior for corresponding to most common apps
set backspace=indent,eol,start

" Hightlight search
set hlsearch

" SignColumn configuration
if has(':signcolumn')
  set signcolumn=number
endif

" Clear highlight when pressing escape
nnoremap <esc> :nohlsearch<return><esc>
nnoremap <esc>^[ <esc>^[

" Keep search matches in the middle of the window.
nnoremap n nzzzv
nnoremap N Nzzzv

" Search as you type character
set incsearch

" Ignore case in search
set ignorecase

" Search with smart case (if uppercase provided, search is case sensitive)
set smartcase

" Omni completion
set completeopt=longest,menuone,noselect,noinsert
set omnifunc=syntaxcomplete#Complete

" Enter select completion
inoremap <expr> <CR> pumvisible() ? "\<C-y>" : "\<C-g>u\<CR>"

" Auto reload file
set autoread

" Disable folding
set nofoldenable

" No bell
set visualbell
set noerrorbells

" Disable backup files
set nobackup
set nowritebackup
set noswapfile

" Increase update time
set updatetime=300

" Change map leader if possible
if exists(":let")
  let mapleader=","
endif

" Navigation shortcut
nmap <silent> gb <C-o>

" Disabling viminfo
set viminfo=""

" Turn on the Wild menu, better suggestion
set wildmenu

" Be lazy when redrawing screen
set lazyredraw

" Printing whitespace characters differently
set list
set listchars=tab:>.,trail:.,extends:#,nbsp:.

" Share clipboard with system
set clipboard=unnamed

" Autoformat code with ctrl+f
noremap <C-f> gg=G<return>

" Smarter tab completion trigger
function! SuperTab()
  let l:part = strpart(getline('.'),col('.')-2,1)
  if (l:part =~ '^\s\?$')
    return "\<Tab>"
  endif

  if (l:part =~ '\/')
    return "\<C-X>\<C-F>"
  endif

  return "\<C-X>\<C-O>"
endfunction

inoremap <Tab> <C-R>=SuperTab()<CR>

" Using ripgrep for searching
if executable("rg")
  set grepprg=rg\ --vimgrep\ --no-heading
  nnoremap <Leader>* :lgrep -P --<Space>
endif

if exists(':autocmd') && exists(':augroup')
  augroup quick_fix
    autocmd!
    " Opening quickfix automatically
    autocmd QuickFixCmdPost [^l]* nested cwindow
    autocmd QuickFixCmdPost    l* nested lwindow
  augroup END

  " Format using external program
  augroup format_config
    autocmd!

    if executable('terraform')
      autocmd FileType tf setlocal equalprg=terraform\ fmt\ -no-color\ -\ 2>/dev/null
    endif

    if executable('black')
      autocmd FileType python setlocal equalprg=black\ --quiet\ -\ 2>/dev/null
    endif

    if executable('prettier')
      autocmd FileType markdown setlocal equalprg=prettier\ --no-color\ --stdin-filepath\ file.md\ 2>/dev/null
      autocmd FileType yaml setlocal equalprg=prettier\ --no-color\ --stdin-filepath\ file.yml\ 2>/dev/null
      autocmd FileType json setlocal equalprg=prettier\ --no-color\ --stdin-filepath\ file.json\ 2>/dev/null
      autocmd FileType js setlocal equalprg=prettier\ --no-color\ --stdin-filepath\ file.js\ 2>/dev/null
      autocmd FileType jsx setlocal equalprg=prettier\ --no-color\ --stdin-filepath\ file.jsx\ 2>/dev/null
    endif

    if executable('goimports')
      autocmd FileType go setlocal equalprg=goimports\ 2>/dev/null
    endif

    if executable('shfmt')
      autocmd FileType sh setlocal equalprg=shfmt\ -s\ -\ 2>/dev/null
    endif
  augroup END
endif

" Save file with sudo permission
if exists(':execute')
  command W :execute ':silent w !sudo tee % > /dev/null' | :edit!
endif

" Search using ctrl-p and fzf
set rtp+=~/opt/fzf
noremap <C-p> :FZF<return>

" vim-plug
call plug#begin('~/.vim/plugged')

Plug 'airblade/vim-gitgutter'
Plug 'editorconfig/editorconfig-vim'
Plug 'mg979/vim-visual-multi', {'branch': 'master'}
Plug 'prabirshrestha/vim-lsp'
Plug 'tpope/vim-surround'
Plug 'vim-syntastic/syntastic'

call plug#end()

" vim-gutter configuration
highlight GitGutterAdd    guifg=#009900 ctermfg=2
highlight GitGutterChange guifg=#bbbb00 ctermfg=3
highlight GitGutterDelete guifg=#ff2222 ctermfg=1
nmap <Leader>z <Plug>(GitGutterUndoHunk)
nmap <Leader>; <Plug>(GitGutterPreviewHunk)
if exists(':let')
  let g:gitgutter_map_keys = 0
endif

" vim-lsp configuration
if executable('pyls')
  au User lsp_setup call lsp#register_server({
        \ 'name': 'pyls',
        \ 'cmd': {server_info->['pyls']},
        \ 'allowlist': ['python'],
        \ })
endif

if executable('gopls')
  au User lsp_setup call lsp#register_server({
        \ 'name': 'gopls',
        \ 'cmd': {server_info->['gopls']},
        \ 'allowlist': ['go'],
        \ })
endif

function! s:on_lsp_buffer_enabled() abort
  setlocal omnifunc=lsp#complete
  setlocal signcolumn=yes

  if exists('+tagfunc') | setlocal tagfunc=lsp#tagfunc | endif
  nmap <buffer> gd         <plug>(lsp-definition)
  nmap <buffer> gr         <plug>(lsp-references)
  nmap <buffer> gi         <plug>(lsp-implementation)
  nmap <buffer> gt         <plug>(lsp-type-definition)
  nmap <buffer> <Leader>rn <plug>(lsp-rename)
  nmap <buffer> <Leader>n  <plug>(lsp-next-diagnostic)
  nmap <buffer> <Leader>N  <plug>(lsp-previous-diagnostic)
  nmap <buffer> K          <plug>(lsp-hover)
  nmap <buffer> <C-i>      <plug>(lsp-document-symbol)
endfunction

if exists(":let")
  let g:lsp_signs_warning = {'text': '‼'}
  let g:lsp_signs_error = {'text': '✗'}
  let g:lsp_diagnostics_float_cursor = 1
  let g:lsp_diagnostics_float_delay = 300
endif

if exists(':autocmd') && exists(':augroup')
  augroup lsp_install
    autocmd!
    autocmd User lsp_buffer_enabled call s:on_lsp_buffer_enabled()
  augroup END
endif

" syntastic configuration
noremap <C-l> :SyntasticCheck<CR>
if exists(":let")
  let g:syntastic_always_populate_loc_list = 1
  let g:syntastic_auto_loc_list = 1
  let g:syntastic_check_on_open = 0
  let g:syntastic_check_on_wq = 0
endif
